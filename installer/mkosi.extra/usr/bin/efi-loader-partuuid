#!/usr/bin/sh
set -euf

efivars='/sys/firmware/efi/efivars/'
systemd_efi_uuid='4a67b082-0a4c-41cf-b6c7-440b29bb8c4f'
efivar_name='LoaderDevicePartUUID'
efivar="${efivar_name}-${systemd_efi_uuid}"
loader_device_partuuid_efivar="${efivars}/${efivar}"

usage() {
  printf 'Usage: %s\n' "${0##*/}"
  printf '%s\n' '' \
    'Print the PARTUUID of the ESP based on EFI firmware variables.'
}

if [ $# -gt 0 ] && [ "$1" = '--help' ] || [ $# -gt 1 ]; then
  usage
  exit 2
fi

cut -b 5- "${loader_device_partuuid_efivar}" | tr -cd '[A-Za-z0-9-]' | tr '[:upper:]' '[:lower:]'
